--EXERCICIO 1

create or replace duracao_ultimo (utNIF number, intEspecialidade varchar, ano number)
return number
is
    CODU UTENTES.CODUTENTE%TYPE;
    
    CURSOR C1 (COD NUMBER) IS
        SELECT *
        FROM INTERNAMENTOS
        WHERE CODUTENTE = COD
        AND TO_CHAR(DATA_INTERN, 'YYYY') = ANO
        AND UPPER(ESPECIALIDADE) = UPPER(intEspecialidade)
        ORDER BY DATAINTERN DESC;
    D NUMBER;

BEGIN
    SELECT CODUTENTE INTO CODU
    FROM UTENTES
    WHERE NIF = UTNIF;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR (-20202, '20203');
END;

FOR R IN C1 (CODU)
LOOP
    BEGIN
    SELECT DURACAO INTO D
    FROM TERMINO
    WHERE CODINTERN = R.CODINTERN
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR (-20202, '20201');
END;
    RETURN D;

END LOOP;
    RAISE_APPLICATION_ERROR (-20201, '20201');
END;
/


--EXERCICIO 2
CREATE PROCEDURE INTERNAMENTOS_CIDADE (VCIDADE VARCHAR, VANO NUMBER)
IS
    CURSOR C1 IS
        SELECT NIF, NOME
        FROM UTENTES
        WHERE UPPER(morada)LIKE '%' UPPER(VCIDADE);
    CURSOR C2 IS
        SELECT DISTINCT ESPECIALIDADE
        FROM MEDICOS
        WHERE UPPER(morada)LIKE '%' UPPER(VCIDADE);
    
    D NUMBER;
    EX EXCEPTION
    PRAGMA EXCEPTION_INIT (EX, -20202);
BEGIN

FOR ESP IN C2
LOOP
    FOR UT IN C1
    LOOP
        BEGIN
            D:= duracao_ultimo (UT, NIF, ESP.ESPECIALIDADE, VANO);
            INSERT INTO TEMP VALUES (VANO, D, UT.NOME, ESP.ESPECIALIDADE);
        EXCEPTION
        WHEN EX THEN
            D:= SQLCODE;
            
            INSERT INTO TEMP VALUES (VANO, D, UT.NOME, ESP. ESPECIALIDADE);
        END;
    END LOOP;
    
END LOOP;
END;
/


--EXERCICIO 3

CREATE TRIGGER UPDATE_INTERNAMENTOS
AFTER INSERT ON TERMINO
FOR EACH ROW
BEGIN
    UPDATE TEMP SET COL2 = :NEW.DURACAO
    WHERE COL2 < 0
    AND (MESSAGE1, MESSAGE2) IN (
            SELECT NOME, ESPECIALIDADE
            FROM INTERNAMENTOS I, UTENTES U
            WHERE I.CODUTENTE = U.CODUTENTE
            AND CODINTERN = :NEW.CODINTERN
    );
   
    
    UPDATE TEMP SET COL2 = :NEW.DURACAO
    WHERE COL2 < 0
    AND (MESSAGE1, MESSAGE2) IN ( 
            SELECT NOME, ESPECIALIDADE
            FROM INTERNAMENTOS I, UTENTES U
            WHERE I.CODUTENTE = U.CODUTENTE
            AND CODINTERN = :NEW.CODINTERN
        );
